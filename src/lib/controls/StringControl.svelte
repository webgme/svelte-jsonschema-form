<script lang="ts">
  import { isString } from "$lib/utilities";
  import UISchema from "$lib/UISchema";
  import Textfield from "@smui/textfield";
  import HelperText from "@smui/textfield/helper-text";
  import Select, { Option } from "@smui/select";

  export let data: string | undefined = $$props.default;
  export let uischema: UISchema = {};
  export let title: string | undefined = undefined;
  export let description: string | undefined = undefined;
  export let format: string | undefined = undefined;
  export let minLength: number | undefined = undefined;
  export let maxLength: number | undefined = undefined;
  export let pattern: string | undefined = undefined;
  export let isRequired: boolean | undefined = undefined;
  export let force: boolean = false;

  export let prepend: ConstructorOfATypedSvelteComponent | string | undefined = undefined;
  export let append: ConstructorOfATypedSvelteComponent | string | undefined = undefined;

  let value: string = data ?? "";
  let enumValues: string[] | undefined = undefined;

  $: uiOptions = UISchema.Options.get(uischema);
  $: updateData(value);
  $: updateValue(data);
  $: enumValues = $$props.enum;


  function updateData(val: string) {
    const setData = (!!val || force) ? val : undefined;
    if (data !== setData) {
      data = setData;
    }
  }

  function updateValue(val: string | undefined) {
    const setValue = val ?? "";
    if (value !== setValue) {
      value = setValue;
    }
  }
  
</script>

<div class="jsonschema-form-control control-string">
  {#if isString(prepend)}
    {@html prepend}
  {:else if prepend != null}
    <svelte:component this={prepend} {...$$props} />
  {/if}

  {#if enumValues?.length}
    <Select 
      variant="outlined"
      bind:value
      label={title}
      required={isRequired}
      menu$portal
      disabled={$uiOptions.readonly}
    >
      {#if !force}
        <Option value={null}/>
      {/if}
      {#each enumValues as enumValue}
        <Option value={enumValue}>{enumValue}</Option>
      {/each}
    </Select>
    {#if description}
      <HelperText persistent>{description}</HelperText>
    {/if}
  {:else}
    <Textfield
      variant="outlined"
      label={title}
      type={format}
      bind:value
      input$minlength={minLength}
      input$maxlength={maxLength}
      input$pattern={pattern}
      required={isRequired}
      disabled={$uiOptions.readonly}
    >
      <svelte:fragment slot="helper">
        {#if description}
          <HelperText persistent>{description}</HelperText>
        {/if}
      </svelte:fragment>
    </Textfield>
  {/if}

  {#if isString(append)}
    {@html append}
  {:else if append != null}
    <svelte:component this={append} {...$$props} />
  {/if}
</div>

<style>
  .control-string {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 3px;
  }

  .control-string > :global(.mdc-text-field),
  .control-string > :global(.mdc-select) {
    width: 100%;
  }
</style>
